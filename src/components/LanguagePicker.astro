---
import { Icon } from 'astro-pure/user'

import { getLangFromUrl, languages } from '../i18n/ui'

const lang = getLangFromUrl(Astro.url)
// Simple toggle logic for 2 languages
const nextLang = lang === 'en' ? 'zh' : 'en'
// Replace current lang in path with next lang
// If current path doesn't start with lang (e.g. root matching), append it.
// Assuming prefix strategy is active and strict.
// Logic: /en/foo -> /zh/foo. /zh/bar -> /en/bar.

// Remove current lang prefix
let pathNoLang = Astro.url.pathname.replace(/^\/(en|zh)/, '')
if (!pathNoLang.startsWith('/')) pathNoLang = '/' + pathNoLang
// Clean double slashes just in case
pathNoLang = pathNoLang.replace(/^\/+/, '/')

const integrityCheck = pathNoLang === '/' ? '' : pathNoLang
const nextUrl = `/${nextLang}${integrityCheck}`

const label = languages[nextLang]
const toggleText = nextLang === 'zh' ? '切换至简体中文' : 'Switch to English'
---

<a
  href={nextUrl}
  class='group/lang box-content size-5 rounded-md border p-1.5 transition-colors hover:bg-border sm:group-[.not-top]:rounded-xl'
  aria-label={toggleText}
  title={toggleText}
  onclick={`localStorage.setItem('toast_msg', '${nextLang === 'zh' ? '已切换至简体中文' : 'Switched to English'}')`}
>
  <div class='relative size-5'>
    <div
      class='transition-colors group-hover/lang:text-primary'
      style={{
        maskImage: 'radial-gradient(circle at 75% 75%, transparent 25%, black 27%)',
        WebkitMaskImage: 'radial-gradient(circle at 75% 75%, transparent 25%, black 27%)'
      }}
    >
      <Icon name='earth' class='size-5' />
    </div>
    <svg
      viewBox='0 0 24 24'
      fill='none'
      class='absolute inset-0 size-5 transition-colors group-hover/lang:text-primary'
    >
      <text
        x='18'
        y='21'
        font-size={lang === 'zh' ? '9' : '7'}
        text-anchor='middle'
        fill='currentColor'
        font-weight='bold'
        font-family='sans-serif'
      >
        {lang === 'zh' ? '简' : 'EN'}
      </text>
    </svg>
  </div>
  <span class='sr-only'>{label}</span>
</a>
