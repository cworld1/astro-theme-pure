<script>
  import { showToast } from 'astro-pure/utils'

  // Helper to load external script
  function loadScript(src: string) {
    return new Promise<void>((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) {
        resolve()
        return
      }
      const script = document.createElement('script')
      script.src = src
      script.onload = () => resolve()
      script.onerror = reject
      document.head.appendChild(script)
    })
  }

  // Localization map
  const messages = {
    en: {
      copySuccess: 'Copied to clipboard',
      copyFail: 'Copy failed',
      downloading: 'Downloading image...',
      accessDenied: 'Clipboard access denied. Downloaded instead.'
    },
    zh: {
      copySuccess: '已复制到剪贴板',
      copyFail: '复制失败',
      downloading: '正在下载图片...',
      accessDenied: '剪贴板访问被拒绝，已改为下载。'
    }
  }

  function getMessage(key: keyof (typeof messages)['en']) {
    const lang = document.documentElement.lang?.startsWith('zh') ? 'zh' : 'en'
    return messages[lang][key]
  }

  function attachCopyButtons() {
    const observer = new MutationObserver((mutations) => {
      let fastScan = false
      for (const m of mutations) {
        if (m.addedNodes.length > 0) fastScan = true
        if (
          m.type === 'attributes' &&
          m.target instanceof HTMLElement &&
          (m.target.classList.contains('collapse') || (m.target as any).open !== undefined)
        )
          fastScan = true
      }
      if (fastScan) scanAndAddButtons()
    })

    observer.observe(document.body, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['class', 'open', 'style']
    })
    scanAndAddButtons()
  }

  function scanAndAddButtons() {
    const blocks = document.querySelectorAll('.mermaid')

    blocks.forEach((block) => {
      if (block.querySelector('.mermaid-copy-btn')) return

      if (block instanceof HTMLElement) {
        if (getComputedStyle(block).position === 'static') {
          block.style.position = 'relative'
        }
      }

      const button = document.createElement('button')
      button.className = 'mermaid-copy-btn'
      button.title = 'Copy Mermaid Diagram'
      button.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      `

      Object.assign(button.style, {
        position: 'absolute',
        top: '8px',
        right: '8px',
        background: 'rgba(50, 50, 50, 0.8)',
        border: '1px solid rgba(255, 255, 255, 0.2)',
        borderRadius: '6px',
        color: '#fff',
        padding: '6px',
        cursor: 'pointer',
        zIndex: '100',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        opacity: '0',
        transition: 'all 0.2s'
      })

      block.addEventListener('mouseenter', () => {
        button.style.opacity = '1'
      })
      block.addEventListener('mouseleave', () => {
        button.style.opacity = '0'
      })
      button.addEventListener('focus', () => {
        button.style.opacity = '1'
      })
      button.addEventListener('blur', () => {
        button.style.opacity = '0'
      })

      button.addEventListener('click', async (e) => {
        e.stopPropagation()
        e.preventDefault()

        const originalHTML = button.innerHTML
        button.innerHTML = `<svg style="animation: spin 1s linear infinite;" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`

        if (!document.getElementById('mermaid-spin-style')) {
          const style = document.createElement('style')
          style.id = 'mermaid-spin-style'
          style.innerHTML = `@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`
          document.head.appendChild(style)
        }

        try {
          if (!(window as any).htmlToImage) {
            await loadScript(
              'https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js'
            )
          }

          const svg = block.querySelector('svg')
          const node = svg || (block as HTMLElement)

          let width = node.scrollWidth
          let height = node.scrollHeight

          if (svg && svg.hasAttribute('viewBox')) {
            const parts = svg.getAttribute('viewBox')!.split(/\s+|,/)
            if (parts.length === 4) {
              width = parseFloat(parts[2])
              height = parseFloat(parts[3])
            }
          } else if (svg && (svg as any).getBBox) {
            try {
              const bbox = (svg as any).getBBox()
              if (bbox.width > 0) width = bbox.width
              if (bbox.height > 0) height = bbox.height
            } catch (e) {}
          }

          const blob = await (window as any).htmlToImage.toBlob(node, {
            backgroundColor: '#ffffff',
            style: {
              overflow: 'visible',
              transform: 'none',
              maxHeight: 'none',
              maxWidth: 'none'
            },
            width: width,
            height: height,
            filter: (n: any) => !n.classList?.contains('mermaid-copy-btn'),
            pixelRatio: 2
          })

          if (!blob) throw new Error('Generated image is empty')

          try {
            await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])
            button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>`
            showToast({ message: getMessage('copySuccess'), icon: 'check' })
          } catch (clipboardErr) {
            const link = document.createElement('a')
            const url = URL.createObjectURL(blob)
            link.download = `mermaid-diagram-${Date.now()}.png`
            link.href = url
            link.click()
            URL.revokeObjectURL(url)

            showToast({ message: getMessage('accessDenied'), icon: 'download' })
            button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`
          }
        } catch (err: any) {
          console.error('Mermaid export failed:', err)
          showToast({ message: getMessage('copyFail') + ': ' + err.message, icon: 'close' })
          button.innerHTML = originalHTML
        }

        setTimeout(() => {
          button.innerHTML = originalHTML
        }, 3000)
      })

      block.appendChild(button)
    })
  }

  document.addEventListener('DOMContentLoaded', attachCopyButtons)
  document.addEventListener('astro:page-load', attachCopyButtons)
  document.addEventListener('astro:after-swap', attachCopyButtons)
</script>
