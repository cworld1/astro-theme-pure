---
import { Footer, ThemeProvider } from 'astro-pure/components/basic'
import type { SiteMeta } from 'astro-pure/types'
import BaseHead from '@/components/BaseHead.astro'
import Header from '@/components/Header.astro'
import config from '@/site-config'

// Import the global.css file here so that it is included on
// all pages through the use of the <BaseLayout /> component.
import '@/assets/styles/global.css'
import '@/assets/styles/app.css'

import { getLangFromUrl } from '@/i18n/ui'

interface Props {
  meta: SiteMeta
  highlightColor?: string
}

const {
  meta: { articleDate, description = config.description, ogImage, title },
  highlightColor,
  ...props
} = Astro.props

const lang = getLangFromUrl(Astro.url)
---

<html lang={lang}>
  <head>
    <BaseHead {articleDate} {description} {ogImage} {title} />
    <script is:inline>
      /* Filter out noisy browser extension logs */
      ;(function () {
        const originalLog = console.log
        const originalInfo = console.info
        const originalDebug = console.debug
        // const originalWarn = console.warn

        const filterArgs = (args) => {
          // Convert args to string check
          const str = args.map((a) => String(a)).join(' ')
          const keywords = [
            'ios-webRequest',
            'debug-metadata',
            'PlayerHookManager',
            'KISS-Translator',
            'siteDubbingRules',
            'HlsJsHook',
            'ShakaPlayerHook',
            'VideoJsHook',
            'JwPlayerHook',
            'DashJsHook'
          ]
          return keywords.some((k) => str.includes(k))
        }

        console.log = function (...args) {
          if (!filterArgs(args)) originalLog.apply(console, args)
        }
        console.info = function (...args) {
          if (!filterArgs(args)) originalInfo.apply(console, args)
        }
        console.debug = function (...args) {
          if (!filterArgs(args)) originalDebug.apply(console, args)
        }
      })()
    </script>
    <ThemeProvider />
  </head>

  <body class='flex justify-center bg-background text-foreground' {...props}>
    {
      highlightColor && (
        <div
          id='highlight-gradient'
          class='pointer-events-none absolute start-0 top-0 z-0 h-screen w-full opacity-25'
          style={`background-image:linear-gradient(${highlightColor},transparent)`}
        />
      )
    }
    <div
      class='w-full max-w-[70rem] px-4 sm:px-7 lg:px-10 min-h-[100dvh] flex flex-col justify-between'
    >
      <Header />
      <div class='flex-1 w-full'>
        <slot />
      </div>
      <Footer />
    </div>

    {/* Set highlight color */}
    <style define:vars={{ highlightColor }}>
      :global(.highlight) {
        --highlight-fg: color-mix(
          in srgb,
          var(--highlightColor) 40%,
          hsl(var(--foreground)/var(--un-text-opacity, 1))
        );
        color: var(--highlight-fg, hsl(var(--primary) / var(--un-text-opacity))) !important;
      }
      :global(.highlight-bg) {
        background-color: var(
          --highlightColor,
          hsl(var(--primary) / var(--un-text-opacity))
        ) !important;
      }
    </style>
    <script
      is:inline
      type='module'
      data-astro-rerun
      define:vars={{ npmCDN: config.npmCDN, walineServer: config.integ.waline.server }}
    >
      const loadPageview = async () => {
        try {
          const pageview = await import(`${npmCDN}/@waline/client@v3/dist/pageview.js`)
          await pageview.pageviewCount({
            serverURL: walineServer
          })
        } catch (e) {
          console.error('Failed to load Waline pageview:', e)
        }
      }

      loadPageview()
      setTimeout(loadPageview, 1000)
    </script>
  </body>
</html>
