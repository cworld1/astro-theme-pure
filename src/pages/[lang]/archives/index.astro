---
import { languages, useTranslations } from '@/i18n/ui'

import { PostPreview } from 'astro-pure/components/pages'
import { getBlogCollection, groupCollectionsByYear, sortMDByDate } from 'astro-pure/server'
import { Button } from 'astro-pure/user'
import PageLayout from '@/layouts/BaseLayout.astro'

export const prerender = true

export async function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({ params: { lang } }))
}

const { lang } = Astro.params
const t = useTranslations(lang as any)

const allPosts = await getBlogCollection()
const langPosts = allPosts.filter((post) => {
  const [postLang] = post.id.split('/')
  return postLang === lang
})
const allPostsByDate = sortMDByDate(langPosts)
const allPostsByYear = groupCollectionsByYear(allPostsByDate)

const meta = {
  description: t('archive.desc'),
  title: t('archive.title')
}
---

<PageLayout {meta}>
  <Button title={t('common.back')} href={`/${lang}/blog`} variant='back' />

  <main class='mt-6 lg:mt-10'>
    <div id='content-header' class='animate'>
      <h1 class='mb-6 text-3xl font-medium'>{t('archive.title')}</h1>
    </div>

    {langPosts.length === 0 && <p>{t('home.no_posts')}</p>}

    <section id='content' class='animate' aria-label='Blog post list'>
      {
        allPostsByYear.map(([year, posts]) => (
          <div class='relative mt-20'>
            <h2
              class='absolute -start-6 -top-16 z-0 text-9xl font-bold text-transparent opacity-12 dark:opacity-25'
              style='-webkit-text-stroke-width:2px;-webkit-text-stroke-color:hsl(var(--foreground)/var(--un-text-opacity))'
            >
              <samp>{year}</samp>
            </h2>
            <p class='px-5 text-muted-foreground'>
              {posts.length} post{posts.length > 1 && 's'}
            </p>
            <ul class='flex flex-col text-start'>
              {posts.map((p) => (
                <PostPreview post={p} class='border-0 bg-transparent py-2' />
              ))}
            </ul>
          </div>
        ))
      }
    </section>
  </main>
</PageLayout>
