---
import projectContext from 'virtual:project-context'
export const prerender = true

// Generates static paths for the `[lang]/[...slug]` route using the default locale.
// Astro uses this to prerender localized routes.
export async function getStaticPaths() {
  const defaultLocale = projectContext?.i18n?.defaultLocale
  const modules = import.meta.glob('/src/pages/**/*.astro')
  const files = Object.keys(modules)
    .filter((f) => !f.includes('['))
    .map((f) => f.replace(/^\/src\/pages/, ''))
    .map((p) => (p.endsWith('/index.astro') ? p.replace(/\/index\.astro$/, '/') : p))
    .map((p) => p.replace(/\.astro$/, ''))
    .map((p) => p.replace(/\/$/, ''))
    .map((p) => p.replace(/^\//, ''))
    .filter((p) => p !== '')
  const dynamicRoots = Object.keys(modules)
    .filter((f) => f.includes('['))
    .map((f) => f.replace(/^\/src\/pages\//, ''))
    .map((p) => p.replace(/\[.*$/, ''))
    .map((p) => p.replace(/\/$/, ''))
    .map((p) => p.replace(/^\//, ''))
    .filter((p) => p !== '')
  const candidates = files.concat(dynamicRoots)
  if (Object.keys(modules).some((f) => /\/src\/pages\/blog\/\[/.test(f))) candidates.push('blog')
  const unique = Array.from(new Set(candidates))
  return unique.map((slug) => ({ params: { lang: defaultLocale, slug } }))
}

const { slug } = Astro.params
const target = `/${Array.isArray(slug) ? slug.join('/') : slug}`
return Astro.redirect(target)
---