---
import type { MarkdownHeading } from 'astro'
import { changelogEntries } from '@/data/changelog'
import { languages, useTranslations } from '@/i18n/ui'

import type { TimelineEvent } from 'astro-pure/types'
import { Timeline } from 'astro-pure/user'
import PageLayout from '@/layouts/CommonPage.astro'

export const prerender = true

export async function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({ params: { lang } }))
}

const { lang } = Astro.params
const t = useTranslations(lang as any)

// 根据当前语言转换 changelog 数据为 Timeline 组件所需格式
const timelineEvents: TimelineEvent[] = changelogEntries.map((entry) => ({
  date: entry.date,
  content: lang === 'zh' ? entry.zh : entry.en
}))

// 页面目录
const uniqueDates = [...new Set(changelogEntries.map((entry) => entry.date))]
const headings: MarkdownHeading[] = [
  { depth: 2, slug: 'latest-update', text: lang === 'zh' ? '最新更新' : 'Latest Update' },
  ...uniqueDates.map((date) => ({
    depth: 2,
    slug: date,
    text: date
  }))
]
---

<PageLayout
  title={t('changelog.title')}
  tocTitle={lang === 'zh' ? '更新时间' : 'Update Time'}
  {headings}
>
  <div class='toc-anchor changelog-intro mb-8' id='latest-update'>
    <p class='text-lg text-muted-foreground'>
      {t('changelog.intro')}
    </p>
  </div>

  <Timeline events={timelineEvents} class='changelog-timeline' />
</PageLayout>

<style>
  .changelog-timeline {
    @apply max-w-4xl;
  }

  .changelog-intro p {
    @apply leading-relaxed;
  }
</style>
