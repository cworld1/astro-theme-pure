---
import { Image } from 'astro:assets'
import { languages, useTranslations } from '@/i18n/ui'

import { Quote } from 'astro-pure/advanced'
import { PostPreview } from 'astro-pure/components/pages'
import { getBlogCollection, getUniqueTagsWithCount, sortMDByDate } from 'astro-pure/server'
import { Button, Card, Icon, Label } from 'astro-pure/user'
import PageLayout from '@/layouts/BaseLayout.astro'
import ProjectCard from '@/components/home/ProjectCard.astro'
import Section from '@/components/home/Section.astro'
import SkillLayout from '@/components/home/SkillLayout.astro'
import config from '@/site-config'

export const prerender = false

// export const prerender = false // Keep this as is from previous step (implicit)

// export async function getStaticPaths() {
//   return Object.keys(languages).map((lang) => ({ params: { lang } }))
// }

const { lang } = Astro.params
const t = useTranslations(lang as any)

// ... (rest of the file until script)

// Unused lists removed

const MAX_POSTS = 4
const allPosts = await getBlogCollection()
// Filter posts by language
const langPosts = allPosts.filter((post) => {
  const [postLang] = post.id.split('/')
  return postLang === lang
})

const sortedPosts = sortMDByDate(langPosts)
const allTags = getUniqueTagsWithCount(langPosts)
// Show all posts for filtering, not just recommended
const allPostsByDate = sortedPosts.slice(0, MAX_POSTS)

const imagePath = config.logo.src
const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/*.{jpeg,jpg,png,gif,avif,webp}'
)
if (!images[imagePath])
  throw new Error(
    `"${imagePath}" does not exist in glob: "src/assets/*.{jpeg,jpg,png,gif,avif,webp}"`
  )

// --- Rainbow color scheme for tags ---
const rainbowColors = ['#428BCA', '#AEDCAE', '#ECA9A7', '#DA99FF', '#FFB380', '#D9B999']

function getTagColor(tagName: string) {
  const index = tagName.length % rainbowColors.length
  return rainbowColors[index]
}
---

<PageLayout meta={{ title: t('nav.home') }} highlightColor='#659EB9'>
  <main class='flex w-full flex-col items-center'>
    <section class='animate mb-10 flex flex-col items-center gap-y-7' id='content-header'>
      <Image
        src={images[imagePath]()}
        alt={config.logo.alt || 'Profile'}
        class='h-28 w-auto rounded-full border p-1 cursor-pointer'
        id='hero-avatar'
        loading='eager'
        fetchpriority='high'
      />
      <div class='flex flex-col items-center gap-y-4'>
        <h1 id='hero-author-name' class='text-3xl font-medium cursor-pointer'>{config.author}</h1>
        <div class='flex flex-wrap justify-center gap-x-7 gap-y-3'>
          <Label title='‰∏≠ÂõΩ¬∑ÂπøÂ∑û'>
            <Icon name='location' class='size-5' slot='icon' />
          </Label>
          <Label
            title='Á§æ‰∫§Â™í‰Ωì'
            as='a'
            href='https://www.xiaohongshu.com/user/profile/6827e549000000000a03ce6b'
            target='_blank'
          >
            <Icon name='earth' class='size-5' slot='icon' />
          </Label>
        </div>
      </div>

      <a
        href='https://www.xiaohongshu.com/user/profile/6827e549000000000a03ce6b'
        target='_blank'
        class='flex flex-row items-center gap-x-3 rounded-full border px-4 py-2 text-sm shadow-sm transition-shadow hover:shadow-md'
      >
        <span class='relative flex items-center justify-center'>
          <span
            class='absolute size-2 animate-ping rounded-full border border-green-400 bg-green-400 opacity-75'
          ></span>
          <span class='size-2 rounded-full bg-green-400'></span>
        </span>
        <p class='font-medium text-muted-foreground'>{t('home.profile_desc')}</p>
      </a>
    </section>

    <div id='content' class='animate flex flex-col gap-y-10 md:w-4/5 lg:w-5/6'>
      {/* Unified Blog Section with Topic Filters */}
      {
        allPostsByDate.length > 0 && (
          <Section title={t('nav.blog')}>
            {/* Horizontal Topic Filter Bar */}
            <div class='mb-4 flex flex-col gap-y-2.5'>
              <p class='text-xs font-medium uppercase tracking-wide text-muted-foreground/60'>
                {lang === 'zh' ? 'Á≠õÈÄâ' : 'Filter'}
              </p>
              <div class='flex flex-wrap gap-1.5'>
                {/* All Button */}
                <button
                  data-tag='all'
                  class='topic-filter active rounded-lg border border-border/50 bg-gradient-to-br from-primary/90 to-primary px-3 py-1.5 text-xs font-semibold text-primary-foreground shadow-sm transition-all duration-200 hover:shadow-md hover:scale-[1.02] active:scale-95'
                >
                  <span>{lang === 'zh' ? 'ÂÖ®ÈÉ®' : 'All'}</span>
                  <span class='ml-1.5 rounded bg-white/25 px-1.5 py-0.5 text-[10px] font-bold'>
                    {allPostsByDate.length}
                  </span>
                </button>

                {/* Auto-generated Tag Filters */}
                {allTags.map(([tagName, count]) => (
                  <button
                    data-tag={tagName}
                    class='topic-filter rounded-lg border border-border/40 bg-muted/50 px-3 py-1.5 text-xs font-medium text-foreground/80 backdrop-blur-sm transition-all duration-200 hover:border-border hover:bg-muted hover:text-foreground hover:shadow-sm hover:scale-[1.02] active:scale-95'
                  >
                    <span>{t(`tag.${tagName.toLowerCase()}` as any) || tagName}</span>
                    <span class='ml-1.5 rounded bg-foreground/10 px-1.5 py-0.5 text-[10px] font-semibold'>
                      {count}
                    </span>
                  </button>
                ))}

                {/* View All Tags Link */}
                <a
                  href={`/${lang}/tags`}
                  class='flex items-center gap-1 rounded-lg border border-dashed border-border/50 bg-transparent px-3 py-1.5 text-xs font-medium text-muted-foreground transition-all duration-200 hover:border-solid hover:border-border hover:bg-muted/30 hover:text-foreground'
                >
                  {t('tags.view_all')}
                  <svg class='size-3' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                    <path
                      stroke-linecap='round'
                      stroke-linejoin='round'
                      stroke-width='2'
                      d='M9 5l7 7-7 7'
                    />
                  </svg>
                </a>
              </div>
            </div>

            {/* Blog Posts List */}
            <ul id='blog-list' class='flex flex-col gap-y-3'>
              {allPostsByDate.map((p) => (
                <li
                  class='blog-post opacity-100 transition-all duration-300'
                  data-tags={p.data.tags.join(',')}
                >
                  <PostPreview post={p} detailed />
                </li>
              ))}
            </ul>

            {/* No Posts Message */}
            <div id='no-posts-message' class='hidden py-12 text-center text-muted-foreground'>
              <div class='mx-auto max-w-sm'>
                <p class='mb-2 text-4xl'>üòÖ</p>
                <p class='mb-1 text-base font-medium'>
                  {lang === 'zh' ? 'ÊöÇÊó†ÂåπÈÖçÁöÑÊñáÁ´†' : 'No matching posts'}
                </p>
                <p class='text-sm'>{lang === 'zh' ? 'ËØïËØïÂÖ∂‰ªñËØùÈ¢òÂêß' : 'Try another topic'}</p>
              </div>
            </div>

            {/* More Posts Button */}
            <div class='mt-6 flex justify-end'>
              <Button
                title={t('home.more_posts')}
                class='w-fit'
                href={`/${lang}/blog`}
                variant='ahead'
              />
            </div>
          </Section>
        )
      }

      <Section title={t('home.website_list')}>
        <div class='grid grid-cols-1 gap-3 sm:grid-cols-2'>
          <ProjectCard
            href='https://type.bytecho.tech'
            heading={t('home.project.type.heading')}
            subheading={t('home.project.type.subheading')}
            imagePath='/src/assets/projects/1.jpg'
          />
          <ProjectCard
            href='https://post.bytecho.tech'
            heading={t('home.project.post.heading')}
            subheading={t('home.project.post.subheading')}
            imagePath='/src/assets/projects/2.jpg'
          />
        </div>
      </Section>
    </div>
    <Quote class='mt-12 bg-background' />
  </main>
</PageLayout>

<script>
  import { showToast } from 'astro-pure/utils'

  // Topic Filtering Functionality
  function initTopicFilters() {
    console.log('Use Topic Filtering')
    const filterButtons = document.querySelectorAll('.topic-filter')
    const blogPosts = document.querySelectorAll('.blog-post')
    const noPostsMessage = document.getElementById('no-posts-message')
    const blogList = document.getElementById('blog-list')

    if (!filterButtons.length || !blogPosts.length) {
      console.log('Filters or posts not found', {
        buttons: filterButtons.length,
        posts: blogPosts.length
      })
      return
    }

    function filterPosts(selectedTag: string) {
      let visibleCount = 0
      console.log(`Filtering for tag: ${selectedTag}`)

      blogPosts.forEach((post) => {
        const postTagsStr = post.getAttribute('data-tags') || ''
        const postTags = postTagsStr.split(',').map((tag) => tag.trim().toLowerCase())
        const shouldShow = selectedTag === 'all' || postTags.includes(selectedTag.toLowerCase())

        const htmlPost = post as HTMLElement

        if (shouldShow) {
          visibleCount++
          post.classList.remove('hidden')
          // Reset inline styles that might have been added by previous hides
          htmlPost.style.display = ''

          // Simple fade-in effect
          htmlPost.style.opacity = '0'
          htmlPost.style.transform = 'translateY(10px)'
          requestAnimationFrame(() => {
            htmlPost.style.opacity = '1'
            htmlPost.style.transform = 'translateY(0)'
          })
        } else {
          post.classList.add('hidden')
          htmlPost.style.display = 'none' // Explicitly set none to ensure it overrides everything
        }
      })

      // Show/hide no posts message
      if (visibleCount === 0) {
        noPostsMessage?.classList.remove('hidden')
        blogList?.classList.add('hidden')
      } else {
        noPostsMessage?.classList.add('hidden')
        blogList?.classList.remove('hidden')
      }
    }

    filterButtons.forEach((button) => {
      button.addEventListener('click', (e) => {
        e.preventDefault()
        const target = e.currentTarget as HTMLElement
        const selectedTag = target.getAttribute('data-tag')
        if (!selectedTag) return

        // Update active state
        filterButtons.forEach((btn) => {
          btn.classList.remove('active')
          if (btn.getAttribute('data-tag') !== 'all') {
            btn.classList.remove('shadow-md', 'border-border')
            btn.classList.add('border-border/40')
          } else {
            btn.classList.remove(
              'bg-gradient-to-br',
              'from-primary/90',
              'to-primary',
              'text-primary-foreground',
              'border-border/50'
            )
            btn.classList.add('bg-muted/50', 'text-foreground/80', 'border-border/40')
          }
        })

        // Set active state for clicked button
        target.classList.add('active')
        if (selectedTag === 'all') {
          target.classList.remove('bg-muted/50', 'text-foreground/80', 'border-border/40')
          target.classList.add(
            'bg-gradient-to-br',
            'from-primary/90',
            'to-primary',
            'text-primary-foreground',
            'border-border/50',
            'shadow-md'
          )
        } else {
          target.classList.remove('border-border/40')
          target.classList.add('border-border', 'shadow-md')
        }

        filterPosts(selectedTag)

        // Show toast for feedback
        if (selectedTag !== 'all') {
          const tagText = target.querySelector('span:first-child')?.textContent || selectedTag
          showToast({
            message: `${tagText}`,
            icon: 'filter',
            time: 1500
          })
        }
      })
    })
  }

  // Easter Egg Script
  const messages = [
    'Hello! üëã',
    'Coding is fun! üíª',
    'Have a nice day! ‚òÄÔ∏è',
    'Stop poking me! üò†',
    'You found a secret! ü•ö',
    'Bytecho Tech rules! üöÄ',
    'Do you like this theme? üé®',
    'Keep learning! üìö',
    'Coffee time? ‚òï',
    'Bug free code! üêõüö´'
  ]
  const types = ['info', 'success', 'warning', 'error']
  const icons = [
    'github',
    'twitter',
    'mastodon',
    'ufo',
    'alien',
    'brain',
    'robot',
    'rocket',
    'fire',
    'heart'
  ]

  function setupEasterEgg() {
    const avatar = document.getElementById('hero-avatar')
    const author = document.getElementById('hero-author-name')

    function triggerEasterEgg() {
      const randomMsg = messages[Math.floor(Math.random() * messages.length)]
      const randomType = types[Math.floor(Math.random() * types.length)]
      const randomIcon = icons[Math.floor(Math.random() * icons.length)]

      showToast({
        message: randomMsg,
        type: randomType as any,
        icon: randomIcon as any,
        time: 2000
      })
    }

    avatar?.addEventListener('click', triggerEasterEgg)
    author?.addEventListener('click', triggerEasterEgg)
  }

  // Initialize on page load (support for View Transitions)
  document.addEventListener('astro:page-load', () => {
    initTopicFilters()
    setupEasterEgg()
  })

  // Fallback for initial load if not using View Transitions or if script runs after event
  if (document.readyState === 'complete') {
    initTopicFilters()
    setupEasterEgg()
  } else {
    document.addEventListener('DOMContentLoaded', () => {
      initTopicFilters()
      setupEasterEgg()
    })
  }
</script>
