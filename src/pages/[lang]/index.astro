---
import { Image } from 'astro:assets'
import { useTranslations } from '@/i18n/ui'

import { Quote } from 'astro-pure/advanced'
import { PostPreview } from 'astro-pure/components/pages'
import { getBlogCollection, getUniqueTagsWithCount, sortMDByDate } from 'astro-pure/server'
import { Button, Icon, Label } from 'astro-pure/user'
import PageLayout from '@/layouts/BaseLayout.astro'
import ProjectCard from '@/components/home/ProjectCard.astro'
import Section from '@/components/home/Section.astro'
import config from '@/site-config'

export const prerender = false

// export const prerender = false // Keep this as is from previous step (implicit)

// export async function getStaticPaths() {
//   return Object.keys(languages).map((lang) => ({ params: { lang } }))
// }

const { lang } = Astro.params
const t = useTranslations(lang as any)

// ... (rest of the file until script)

// Unused lists removed

const MAX_POSTS = 4
const allPosts = await getBlogCollection()
// Filter posts by language
const langPosts = allPosts.filter((post) => {
  const [postLang] = post.id.split('/')
  return postLang === lang
})

const sortedPosts = sortMDByDate(langPosts)
const allTags = getUniqueTagsWithCount(langPosts)
// Show all posts for filtering, not just recommended
const allPostsByDate = sortedPosts.slice(0, MAX_POSTS)

const imagePath = config.logo.src
const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/*.{jpeg,jpg,png,gif,avif,webp}'
)
if (!images[imagePath])
  throw new Error(
    `"${imagePath}" does not exist in glob: "src/assets/*.{jpeg,jpg,png,gif,avif,webp}"`
  )

// --- Rainbow color scheme for tags ---
const rainbowColors = ['#428BCA', '#AEDCAE', '#ECA9A7', '#DA99FF', '#FFB380', '#D9B999']
---

<PageLayout meta={{ title: t('nav.home') }} highlightColor='#659EB9'>
  <main class='flex w-full flex-col items-center'>
    <section class='animate mb-10 flex flex-col items-center gap-y-7' id='content-header'>
      <Image
        src={images[imagePath]()}
        alt={config.logo.alt || 'Profile'}
        class='h-28 w-auto rounded-full border p-1 cursor-pointer'
        id='hero-avatar'
        loading='eager'
        fetchpriority='high'
      />
      <div class='flex flex-col items-center gap-y-4'>
        <h1 id='hero-author-name' class='text-3xl font-medium cursor-pointer'>{config.author}</h1>
        <div class='flex flex-wrap justify-center gap-x-7 gap-y-3'>
          <Label title='ä¸­å›½Â·å¹¿å·ž'>
            <Icon name='location' class='size-5' slot='icon' />
          </Label>
          <Label
            title='ç¤¾äº¤åª’ä½“'
            as='a'
            href='https://www.xiaohongshu.com/user/profile/6827e549000000000a03ce6b'
            target='_blank'
          >
            <Icon name='earth' class='size-5' slot='icon' />
          </Label>
        </div>
      </div>

      <a
        href='https://www.xiaohongshu.com/user/profile/6827e549000000000a03ce6b'
        target='_blank'
        class='flex flex-row items-center gap-x-3 rounded-full border px-4 py-2 text-sm shadow-sm transition-shadow hover:shadow-md'
      >
        <span class='relative flex items-center justify-center'>
          <span
            class='absolute size-2 animate-ping rounded-full border border-green-400 bg-green-400 opacity-75'
          ></span>
          <span class='size-2 rounded-full bg-green-400'></span>
        </span>
        <p class='font-medium text-muted-foreground'>{t('home.profile_desc')}</p>
      </a>
    </section>

    <div id='content' class='animate flex flex-col gap-y-10 md:w-4/5 lg:w-5/6'>
      {/* Unified Blog Section with Topic Filters */}
      {
        allPostsByDate.length > 0 && (
          <Section title={t('nav.blog')}>
            {/* Topic Filter Section - Inline Layout */}
            <div class='mb-2 flex flex-col gap-y-2'>
              {/* Single Row: Icon + Title + Tags */}
              <div class='flex flex-wrap items-center gap-2'>
                {/* Icon and Title with Colon */}
                <div class='flex items-center gap-2'>
                  <svg class='size-5 text-foreground' fill='currentColor' viewBox='0 0 24 24'>
                    <path d='M10.238 4.827a3 3 0 0 1 2.122.878l6.485 6.486a3 3 0 0 1 0 4.242l-4.243 4.243a3 3 0 0 1-4.242 0l-6.486-6.485a3 3 0 0 1-.878-2.122V7.327a2.5 2.5 0 0 1 2.5-2.5zm0 2H5.496a.5.5 0 0 0-.5.5v4.742a1 1 0 0 0 .292.707l6.486 6.486a1 1 0 0 0 1.414 0l4.243-4.243a1 1 0 0 0 0-1.414L10.945 7.12a1 1 0 0 0-.707-.293M7.531 9.362a1.5 1.5 0 1 1 2.121 2.122a1.5 1.5 0 0 1-2.121-2.122M11.652 2a3 3 0 0 1 2.122.878l7.192 7.193a1 1 0 0 1-1.414 1.414L12.36 4.29a1 1 0 0 0-.708-.29H7a1 1 0 0 1 0-2z' />
                  </svg>
                  <h3 class='text-base font-medium text-foreground'>
                    {lang === 'zh' ? 'æ ‡ç­¾ï¼š' : 'Tags:'}
                  </h3>
                </div>

                {/* Individual Tags with Count Badges */}
                {allTags.map(([tagName, count], index) => {
                  // Generate different colors for count badges
                  const colors = [
                    'bg-blue-500',
                    'bg-green-500',
                    'bg-purple-500',
                    'bg-orange-500',
                    'bg-pink-500',
                    'bg-teal-500'
                  ]
                  const colorClass = colors[index % colors.length]

                  return (
                    <a
                      href={`/${lang}/tags/${tagName.toLowerCase()}`}
                      class='group flex items-center gap-1.5 rounded-md bg-muted px-3 py-1.5 text-sm text-foreground transition-colors hover:bg-muted/70'
                    >
                      <span>{t(`tag.${tagName.toLowerCase()}` as any) || tagName}</span>
                      <span
                        class={`size-5 flex items-center justify-center rounded-full ${colorClass} text-[10px] font-bold text-white`}
                      >
                        {count}
                      </span>
                    </a>
                  )
                })}

                {/* View All as Tag */}
                <Button
                  href={`/${lang}/tags`}
                  title={lang === 'zh' ? 'æŸ¥çœ‹æ‰€æœ‰' : 'View All'}
                  variant='ahead'
                  class='rounded-md bg-muted px-3 py-1.5 text-sm text-foreground transition-colors hover:bg-muted/70 border-none'
                />
              </div>

              {/* Separator Line */}
              <div class='border-t border-border/50' />
            </div>

            {/* Blog Posts List */}
            <ul class='flex flex-col gap-y-3'>
              {allPostsByDate.map((p, index) => (
                <li
                  class='animate-fade-in transition-all duration-300'
                  style={`animation-delay: ${index * 50}ms`}
                >
                  <PostPreview post={p} detailed />
                </li>
              ))}
            </ul>

            {/* More Posts Button */}
            <div class='mt-6 flex justify-end'>
              <Button
                title={t('home.more_posts')}
                class='w-fit'
                href={`/${lang}/blog`}
                variant='ahead'
              />
            </div>
          </Section>
        )
      }

      <Section title={t('home.website_list')}>
        <div class='grid grid-cols-1 gap-3 sm:grid-cols-2'>
          <ProjectCard
            href='https://type.bytecho.tech'
            heading={t('home.project.type.heading')}
            subheading={t('home.project.type.subheading')}
            imagePath='/src/assets/projects/1.jpg'
          />
          <ProjectCard
            href='https://post.bytecho.tech'
            heading={t('home.project.post.heading')}
            subheading={t('home.project.post.subheading')}
            imagePath='/src/assets/projects/2.jpg'
          />
        </div>
      </Section>
    </div>
    <Quote class='mt-12 bg-background' />
  </main>
</PageLayout>

<script>
  import { showToast } from 'astro-pure/utils'

  // Easter Egg Script
  const messages = [
    'Hello! ðŸ‘‹',
    'Coding is fun! ðŸ’»',
    'Have a nice day! â˜€ï¸',
    'Stop poking me! ðŸ˜ ',
    'You found a secret! ðŸ¥š',
    'Bytecho Tech rules! ðŸš€',
    'Do you like this theme? ðŸŽ¨',
    'Keep learning! ðŸ“š',
    'Coffee time? â˜•',
    'Bug free code! ðŸ›ðŸš«'
  ]
  const types = ['info', 'success', 'warning', 'error']
  const icons = [
    'github',
    'twitter',
    'mastodon',
    'ufo',
    'alien',
    'brain',
    'robot',
    'rocket',
    'fire',
    'heart'
  ]

  function setupEasterEgg() {
    const avatar = document.getElementById('hero-avatar')
    const author = document.getElementById('hero-author-name')

    function triggerEasterEgg() {
      const randomMsg = messages[Math.floor(Math.random() * messages.length)]
      const randomType = types[Math.floor(Math.random() * types.length)]
      const randomIcon = icons[Math.floor(Math.random() * icons.length)]

      showToast({
        message: randomMsg,
        type: randomType as any,
        icon: randomIcon as any,
        time: 2000
      })
    }

    avatar?.addEventListener('click', triggerEasterEgg)
    author?.addEventListener('click', triggerEasterEgg)
  }

  // Initialize on page load (support for View Transitions)
  document.addEventListener('astro:page-load', () => {
    setupEasterEgg()
  })
</script>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.5s ease-out forwards;
    opacity: 0;
  }
</style>
