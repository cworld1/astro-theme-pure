---
import type { GetStaticPaths } from 'astro'
import { getCollection } from 'astro:content'
import { languages, useTranslations } from '@/i18n/ui'

import { Button, Icon } from 'astro-pure/user'
import PageLayout from '@/layouts/BaseLayout.astro'
import CapitalCurve from '@/components/trading/CapitalCurve.astro'
import StatsCard from '@/components/trading/StatsCard.astro'
import { calculateEquityCurve } from '@/utils/tradeCalculations'

export const prerender = true

export const getStaticPaths = (async () => {
  return Object.keys(languages).map((lang) => ({
    params: { lang }
  }))
}) satisfies GetStaticPaths

const { lang } = Astro.params
const t = useTranslations(lang as any)

// Fetch all trades to display valid tickers
const allTrades = await getCollection('trades')
const uniqueTickers = [...new Set(allTrades.map((t) => t.data.ticker))]

const meta = {
  description: t('stocks.desc'),
  title: t('stocks.title')
}

const equityData = calculateEquityCurve(allTrades)
---

<PageLayout {meta}>
  <Button title={t('common.back')} href={`/${lang}`} variant='back' />
  <main class='mt-6 lg:mt-10'>
    <div id='content-header' class='animate'>
      <h1 class='mb-6 mt-6 text-3xl font-medium sm:mt-10'>
        {t('stocks.title')}
      </h1>
      <p class='text-muted-foreground mb-8'>{t('stocks.desc')}</p>
    </div>

    {/* Trading Statistics Component */}
    <div class='animate mb-12'>
      <h2 class='mb-4 text-xl font-bold'>Portfolio Performance</h2>
      <StatsCard />

      {/* Capital Curve */}
      <div class='mt-6'>
        <CapitalCurve data={equityData} />
      </div>
    </div>

    {/* Ticker List */}
    <div class='animate'>
      <h2 class='mb-4 flex items-center text-lg font-medium'>
        <Icon name='tag-2' class='me-2' />
        {t('stocks.all_trades')}
      </h2>

      {
        uniqueTickers.length === 0 ? (
          <p class='text-muted-foreground'>{t('home.no_posts')}</p>
        ) : (
          <div class='grid gap-4 sm:grid-cols-2 md:grid-cols-3'>
            {uniqueTickers.map((ticker) => {
              // Find latest trade date for this ticker
              const tickerTrades = allTrades
                .filter((t) => t.data.ticker === ticker)
                .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
              const lastTrade = tickerTrades[0]

              return (
                <a
                  href={`/stocks/${ticker}`}
                  class='block rounded-xl border border-border bg-card p-4 transition-colors hover:bg-muted/50'
                >
                  <div class='flex items-center justify-between mb-2'>
                    <h3 class='text-xl font-bold'>{ticker}</h3>
                    <Icon name='link' class='size-4 text-muted-foreground' />
                  </div>
                  <div class='text-sm text-muted-foreground'>
                    Last Trade: {lastTrade ? lastTrade.data.date.toLocaleDateString() : 'N/A'}
                  </div>
                </a>
              )
            })}
          </div>
        )
      }
    </div>
  </main>
</PageLayout>
