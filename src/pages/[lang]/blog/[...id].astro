---
import { i18n } from 'astro:config/client'
import { getCollection, render, type CollectionEntry } from 'astro:content'
import { toPaths as getConfiguredLocalePaths } from 'astro:i18n'

import { normalizeLocaleBlogId } from 'astro-pure/utils'
import PostLayout from '@/layouts/BlogPost.astro'

export const prerender = true

export async function getStaticPaths() {
  const posts = await getCollection('blog')
  const locales = getConfiguredLocalePaths(i18n?.locales ?? [])
  return posts.flatMap((post) =>
    locales.map((lang) => ({
      params: { lang, id: normalizeLocaleBlogId(post.id) },
      props: { post, posts }
    }))
  )
}

interface Props {
  post: CollectionEntry<'blog'>
  posts: CollectionEntry<'blog'>[]
}

const { post, posts } = Astro.props as Props
const { Content, headings, remarkPluginFrontmatter } = await render(post as CollectionEntry<'blog'>)
---

<PostLayout
  headings={headings}
  remarkPluginFrontmatter={remarkPluginFrontmatter}
  post={post}
  posts={posts}
>
  <Content />
</PostLayout>
